<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet"> 
        <link rel="shortcut icon" href="images/elementos/Medo.webp" type="image/x-icon">
        <link rel="stylesheet" href="styles/quiz.css">
        <title>4Elementos</title>

        <script type="application/javascript" src="questions.js"></script>
        <script type="application/javascript" src="elements.js"></script>
    </head>

    <body>    
        <div class="quiz-container">
            <div class="title">
                <h2>4Elementos - Teste de Afinidade</h2>
            </div>
            <div class="recomendation">
                <p>Recomendamos fortemente que você evite em marcar a opção "neutro" para um resultado mais preciso do teste. Utilize o botão voltar para mudar uma resposta, se precisar.</p>
            </div>

            <div>
                <p id="order" class="order"></p>
                <div id="question" class="question"></div>
            </div>

            <div class="options">
                <label class="option">
                    <input type="button" name="option" id="b1" value="Concordo completamente" onclick="next(2)"/>
                </label><br>
                
                <label class="option">
                    <input type="button" name="option" id="b2" value="Concordo" onclick="next(1)"/>
                </label><br>
                
                <label class="option">
                    <input type="button" name="option" id="b3" value="Neutro" onclick="next(0)"/>
                </label><br>
    
                <label class="option">
                    <input type="button" name="option" id="b4" value="Discordo" onclick="next(-1)"/>
                </label><br>
    
                <label class="option">
                    <input type="button" name="option" id="b5" value="Discordo completamente" onclick="next(-2)"/>
                </label><br>
            </div>

            <div class="controls">
                <button class="previous">Voltar</button>
            </div>
        </div>
            <div class="result">
        </div>

        <script>
            let answers = new Object;
            let actualQ = 1;
            let qn = 0;
            let result = {
                emocao: 1,
                solidao: 1,
                ordem: 1,
                caos: 1,
            }

            let questionsObject = new Object();
                questions.forEach(populateQO);

            function populateQO(value) {
                questionsObject[value['id']] = value
            }

            let questionsOrder = Object.keys(questionsObject);
                shuffleArray(questionsOrder);
                function shuffleArray(array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                }

            init_question();

            function init_question() {
                document.getElementById("question").innerHTML = `#${qn+1} | ${questionsObject[questionsOrder[qn]].question}`;
            }

            function next(answer) {
                if (qn === questionsOrder.length) {
                    return;
                }

                answers[questionsOrder[qn]] = answer;
                result = {
                    emocao: result.emocao += questionsObject[questionsOrder[qn]].effect.emocao * answer,
                    solidao: result.solidao += questionsObject[questionsOrder[qn]].effect.solidao * answer,
                    ordem: result.ordem += questionsObject[questionsOrder[qn]].effect.ordem * answer,
                    caos: result.caos += questionsObject[questionsOrder[qn]].effect.caos * answer,
                }

                qn++;

                if (qn < questionsOrder.length) {
                    init_question();
                } else {
                    results()
                }
            }

            function results() {
                function percentage(partialValue, totalValue) {
                    totalValue = 55;
                    return (100 * partialValue) / totalValue;
                } 

                const porcentRes =  [
                    10 + Math.floor(percentage(result.emocao)),
                    10 + Math.floor(percentage(result.solidao)),
                    10 + Math.floor(percentage(result.ordem)),
                    10 + Math.floor(percentage(result.caos)),
                ] 

                emocArray = ["Sangue", "Energia", "Morte", "Conhecimento"]
                soliArray = ["Morte", "Conhecimento", "Energia", "Sangue"]
                ordeArray = ["Conhecimento", "Morte", "Sangue", "Energia"]
                caosArray = ["Energia", "Sangue", "Conhecimento", "Morte"]

                function checkElements(val, arr) {
                    if (val > 20) { return arr[0]} else
                    if (val > 10) { return arr[1]} else
                    if (val > 5) { return arr[2]} 
                    else { return arr[3] }
                }

                const userEspectro = [
                    checkElements(porcentRes[0], emocArray),
                    checkElements(porcentRes[1], soliArray),
                    checkElements(porcentRes[2], ordeArray),
                    checkElements(porcentRes[3], caosArray),
                ]

                function validateElement(arr) {
                    const hashmap = arr.reduce( (acc, val) => {
                        acc[val] = (acc[val] || 0 ) + 1
                        return acc
                    },{})
                    return Object.keys(hashmap).filter(x => {
                        return hashmap[x] == Math.max.apply(null, 
                        Object.values(hashmap))
                    })
                }

                document.getElementById("question").innerHTML = `Seu elemento é: ${validateElement(userEspectro)}`;
            }

        </script>
    </body>
</html>